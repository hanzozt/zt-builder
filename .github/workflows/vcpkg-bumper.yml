name: Bump vcpkg version

on:
  workflow_dispatch:
  schedule:
    # Run every day at 10:00 UTC (05:00 EST)
    - cron: 0 10 * * *
  push:
    branches: [ "main" ]

jobs:
  discover_bases:
    if: github.event_name == 'schedule' || github.event_name == 'workflow_dispatch'
    runs-on: ubuntu-latest
    permissions:
      contents: read
    outputs:
      base_branches: ${{ steps.discover.outputs.base_branches }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Discover base branches
        id: discover
        shell: bash
        run: |
          set -euxo pipefail

          git fetch --prune --no-tags origin '+refs/heads/*:refs/remotes/origin/*'

          DEFAULT_BRANCH="${DEFAULT_BRANCH:-}"
          if [ -z "${DEFAULT_BRANCH}" ]; then
            DEFAULT_BRANCH="$(git remote show origin | sed -n 's/^[[:space:]]*HEAD branch:[[:space:]]*//p' | head -n 1)"
          fi
          DEFAULT_BRANCH="${DEFAULT_BRANCH:-main}"

          mapfile -t v_branches < <(git for-each-ref --format='%(refname:short)' 'refs/remotes/origin/v*' | sed 's#^origin/##' | sort -u)

          bases=("${DEFAULT_BRANCH}")
          for b in "${v_branches[@]}"; do
            if [ "${b}" != "${DEFAULT_BRANCH}" ]; then
              bases+=("${b}")
            fi
          done

          json_bases="$(printf '%s\n' "${bases[@]}" | python3 -c 'import sys, json; print(json.dumps([l.strip() for l in sys.stdin if l.strip()]))')"
          echo "base_branches=${json_bases}" >> "${GITHUB_OUTPUT}"

  bump:
    if: github.event_name == 'schedule' || github.event_name == 'workflow_dispatch'
    runs-on: ubuntu-latest
    needs: discover_bases
    permissions:
      contents: write
      pull-requests: write
    strategy:
      fail-fast: false
      matrix:
        base_branch: ${{ fromJson(needs.discover_bases.outputs.base_branches) }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          ref: ${{ matrix.base_branch }}

      - name: Find latest vcpkg version
        id: latest_vcpkg
        uses: gregziegan/fetch-latest-release@v2.0.0
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          repo_path: "microsoft/vcpkg"

      - name: Compare vcpkg version
        id: compare_vcpkg
        shell: bash
        env:
          NEW_VCPKG_VERSION: ${{ vars.VCPKG_VERSION || steps.latest_vcpkg.outputs.tag_name }}
        run: |
          set -o pipefail
          set -o xtrace
          CURRENT_VCPKG_VERSION="$(< ./.vcpkg_version)"
          if [[ "$NEW_VCPKG_VERSION" == "$CURRENT_VCPKG_VERSION" ]]; then
            echo "update_vcpkg=false" | tee -a $GITHUB_OUTPUT
          else
            echo "update_vcpkg=true" | tee -a $GITHUB_OUTPUT
          fi

      - name: Bump version file
        if: steps.compare_vcpkg.outputs.update_vcpkg == 'true'
        shell: bash
        env:
          NEW_VCPKG_VERSION: ${{ vars.VCPKG_VERSION || steps.latest_vcpkg.outputs.tag_name }}
        run: |
          set -o pipefail
          set -o xtrace
          echo -n "$NEW_VCPKG_VERSION" > .vcpkg_version

      - name: Create Pull Request if vcpkg version changed
        if: steps.compare_vcpkg.outputs.update_vcpkg == 'true'
        uses: peter-evans/create-pull-request@v6
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          base: ${{ matrix.base_branch }}
          commit-message: bump vcpkg version to ${{ vars.VCPKG_VERSION || steps.latest_vcpkg.outputs.tag_name }}
          title: bump vcpkg version to ${{ vars.VCPKG_VERSION || steps.latest_vcpkg.outputs.tag_name }}
          body: update vcpkg to version ${{ vars.VCPKG_VERSION || steps.latest_vcpkg.outputs.tag_name }}
          branch: update-vcpkg-${{ vars.VCPKG_VERSION || steps.latest_vcpkg.outputs.tag_name }}-${{ matrix.base_branch }}

  discover_github_sync_targets:
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    runs-on: ubuntu-latest
    permissions:
      contents: read
    outputs:
      has_targets: ${{ steps.discover.outputs.has_targets }}
      target_branches: ${{ steps.discover.outputs.target_branches }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Discover target branches and check for .github changes
        id: discover
        shell: bash
        env:
          BEFORE_SHA: ${{ github.event.before }}
          AFTER_SHA: ${{ github.sha }}
        run: |
          set -euxo pipefail

          git fetch --prune --no-tags origin '+refs/heads/*:refs/remotes/origin/*'

          if [[ "${BEFORE_SHA}" =~ ^0+$ ]]; then
            BEFORE_SHA="${AFTER_SHA}~1"
          fi

          changed_files="$(git diff --name-only "${BEFORE_SHA}" "${AFTER_SHA}" || true)"
          if echo "${changed_files}" | grep -qE '^\.github/'; then
            github_changed=true
          else
            github_changed=false
          fi

          mapfile -t v_branches < <(git for-each-ref --format='%(refname:short)' 'refs/remotes/origin/v*' \
            | sed 's#^origin/##' \
            | grep -E '^v[0-9]+$' \
            | sort -u)

          if [ "${github_changed}" != "true" ] || [ "${#v_branches[@]}" -eq 0 ]; then
            echo "has_targets=false" >> "${GITHUB_OUTPUT}"
            echo "target_branches=[\"__none__\"]" >> "${GITHUB_OUTPUT}"
            exit 0
          fi

          json_targets="$(printf '%s\n' "${v_branches[@]}" | python3 -c 'import sys, json; print(json.dumps([l.strip() for l in sys.stdin if l.strip()]))')"
          echo "has_targets=true" >> "${GITHUB_OUTPUT}"
          echo "target_branches=${json_targets}" >> "${GITHUB_OUTPUT}"

  sync_github_to_release_branches:
    if: needs.discover_github_sync_targets.outputs.has_targets == 'true'
    runs-on: ubuntu-latest
    needs: discover_github_sync_targets
    permissions:
      contents: write
      pull-requests: write
    strategy:
      fail-fast: false
      matrix:
        base_branch: ${{ fromJson(needs.discover_github_sync_targets.outputs.target_branches) }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          ref: ${{ matrix.base_branch }}

      - name: Sync .github directory from main
        id: sync
        shell: bash
        run: |
          set -euxo pipefail

          git fetch --no-tags origin main
          git checkout origin/main -- .github
          git checkout origin/main -- *.md

          if git diff --quiet; then
            echo "has_changes=false" >> "${GITHUB_OUTPUT}"
          else
            echo "has_changes=true" >> "${GITHUB_OUTPUT}"
          fi

      - name: Create Pull Request for .github sync
        if: steps.sync.outputs.has_changes == 'true'
        uses: peter-evans/create-pull-request@v6
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          base: ${{ matrix.base_branch }}
          commit-message: sync .github from main
          title: sync .github from main
          body: "sync .github from main (source: ${{ github.sha }})"
          branch: sync-dotgithub-${{ github.run_id }}-${{ matrix.base_branch }}
