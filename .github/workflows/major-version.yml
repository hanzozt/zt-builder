name: Release latest policy
on:
  release:
    types: [published]

permissions:
  contents: write

jobs:
  actions-tagger:
    runs-on: ubuntu-latest
    steps:
      - name: Check if current release tag is highest semver
        id: version_check
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        shell: bash
        run: |
          set -euo pipefail
          current='${{ github.event.release.tag_name }}'
          highest_published="$(gh release list --repo '${{ github.repository }}' --exclude-drafts --exclude-pre-releases --json tagName --jq '.[].tagName' \
            | grep -E '^v[0-9]+\.[0-9]+\.[0-9]+$' \
            | sort -V \
            | tail -n 1 || true)"

          if [ -z "${highest_published}" ]; then
            echo "is_highest=true" >> "$GITHUB_OUTPUT"
          elif [ "${current}" = "${highest_published}" ]; then
            echo "is_highest=true" >> "$GITHUB_OUTPUT"
          else
            echo "is_highest=false" >> "$GITHUB_OUTPUT"
          fi

      - name: Prevent hotfix releases from becoming Latest
        if: ${{ steps.version_check.outputs.is_highest != 'true' }}
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        shell: bash
        run: |
          set -euo pipefail
          gh api --method PATCH \
            repos/${{ github.repository }}/releases/${{ github.event.release.id }} \
            -f make_latest=false >/dev/null
